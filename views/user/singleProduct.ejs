<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= product.name || "Product" %></title>

  <link rel="icon" href="/img/LL.png">
  <link rel="stylesheet" href="/css/themify-icons.css">
  <link rel="stylesheet" href="/css/flaticon.css">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/all.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/footer.css">
  <link rel="stylesheet" href="/css/singleProduct.css">

  <style>
    .opt-btn.active {
      background-color: #a174a9;
      color: #fff;
      border-color: #a174a9;
    }
  </style>
</head>

<body>

<%- include('../partials/header') %>

<div class="product-main">

  <div class="product-image-box">
    <div id="productCarousel" class="carousel slide" data-bs-ride="carousel"  data-bs-touch="true" data-bs-interval="1500">

      <div class="carousel-indicators">
        <% product.images.forEach((img, index) => { %>
          <button type="button"
            data-bs-target="#productCarousel"
            data-bs-slide-to="<%= index %>"
            class="<%= index === 0 ? 'active' : '' %>">
          </button>
        <% }); %>
      </div>

      <div class="carousel-inner">
        <% product.images.forEach((img, index) => { %>
          <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
            <img src="<%= img %>" class="d-block w-100" alt="<%= product.name %>">
          </div>
        <% }); %>
      </div>
    </div>
  </div>

 

  <div class="product-details">

    <h1 class="p-title"><%= product.name %></h1>
   

<% if (product.averageRate && product.averageRate > 0) { %>
  <div class="product-rating mb-2">
    <% for (let i = 1; i <= 5; i++) { %>
      <% if (i <= Math.floor(product.averageRate)) { %>
        <i class="fas fa-star" style="color:#F28123;"></i>
      <% } else if (i - product.averageRate < 1) { %>
        <i class="fas fa-star-half-alt" style="color:#F28123;"></i>
      <% } else { %>
        <i class="far fa-star" style="color:#F28123;"></i>
      <% } %>
    <% } %>
    <span class="ms-2">(<%= product.averageRate.toFixed(1) %>)</span>
  </div>
<% } else { %>
  <div class="product-rating mb-2">
    <span class="text-muted">No ratings yet</span>
  </div>
<% } %>

    <p class="p-price">â‚¹ <span id="finalPrice"><%= product.price %></span></p>
    <p class="p-shipping">Free Shipping all over India</p>

    <% if (product.description) { %>
      <div class="p-section">
        <p class="label">Description</p>
        <p><%= product.description %></p>
      </div>
    <% } %>

    <% if(product.sizes && product.sizes.length > 0) { %>
      <div class="p-section">
        <p class="label">Size</p>
        <div class="options">
          <% product.sizes.forEach(s => { %>
            <button class="opt-btn size-btn" data-size="<%= s %>"><%= s %></button>
          <% }) %>
        </div>
      </div>
    <% } %>

    <% if(product.fabrics && product.fabrics.length > 0) { %>
      <div class="p-section">
        <p class="label">Fabric</p>
        <div class="options">
          <% product.fabrics.forEach(f => { %>
            <button class="opt-btn fabric-btn" data-fabric="<%= f %>"><%= f %></button>
          <% }) %>
        </div>
      </div>
    <% } %>

    <div class="p-section">
      <p class="label">Category</p>
      <div class="options">
        <button class="opt-btn active"><%= product.category %></button>
      </div>
    </div>

    <a href="/cart/add/<%= product._id %>"
       class="btn-full add-cart-btn"
       onclick="addToCart('<%= product._id %>', this, event)">
      <span class="cart-text">Add to Cart</span>
    </a>

    <a href="/wishlist/add/<%= product._id %>"
       class="btn-full add-cart-btn"
       onclick="addToWishlist('<%= product._id %>', this, event)">
      <span class="wishlist-text">Add to Wishlist</span>
    </a>

  </div>
</div>

<%- include('../partials/footer') %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
 const basePrice = Number('<%= product.price %>');

  const priceEl = document.getElementById("finalPrice");

  const sizePrices = {
    Double: 0,
    Queen: 300,
    King: 600
  };

  const fabricPrices = {
    Cotton: 0,
    Silk: 500,
    Polyester: 200,
    "Bamboo Fabric": 700
  };

  let selectedSize = null;
  let selectedFabric = null;

  function updatePriceIfReady() {
    if (selectedSize && selectedFabric) {
      priceEl.textContent =
        basePrice +
        sizePrices[selectedSize] +
        fabricPrices[selectedFabric];
    }
  }

  document.querySelectorAll(".size-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".size-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedSize = btn.dataset.size;
      updatePriceIfReady();
    });
  });

  document.querySelectorAll(".fabric-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".fabric-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedFabric = btn.dataset.fabric;
      updatePriceIfReady();
    });
  });
</script>

<script>
  function addToCart(productId, el, event) {
    event.preventDefault();

    if (!selectedSize || !selectedFabric) {
      alert("Please select size and fabric");
      return;
    }

    fetch(`/cart/add/${productId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({
        size: selectedSize,
        fabric: selectedFabric
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        el.querySelector(".cart-text").innerText = "Added to Cart";
        el.style.pointerEvents = "none";
        el.style.opacity = "0.85";
      }
    });
  }
</script>

<script>
  function addToWishlist(productId, el, event) {
    event.preventDefault();
    fetch(`/wishlist/add/${productId}`, { method: "GET" })
      .then(res => res.json())
      .then(data => {
        el.querySelector(".wishlist-text").innerText =
          data.exists ? "Already in Wishlist" : "Added to Wishlist";
        el.style.pointerEvents = "none";
        el.style.opacity = "0.85";
      });
  }
</script>

</body>
</html>
