<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
    <link rel="icon" href="/img/LL.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Animation and carousel -->
    <link rel="stylesheet" href="/css/animate.css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css">

    <!-- Font Awesome & Icons -->
    <link rel="stylesheet" href="/css/all.css">
    <link rel="stylesheet" href="/css/flaticon.css">
    <link rel="stylesheet" href="/css/themify-icons.css">

    <!-- Popup & Slider -->
    <link rel="stylesheet" href="/css/magnific-popup.css">
    <link rel="stylesheet" href="/css/slick.css">

    <!-- Shared and page-specific CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/cart.css">
</head>
<body>
    <!-- views/user/cart.ejs -->

<%- include('../partials/header') %>

<!-- dynamic alert messages -->
<% if (success) { %>
  <div class="alert alert-success text-center" role="alert">
    <%= success %>
  </div>
<% } %>

<% if (error) { %>
  <div class="alert alert-danger text-center" role="alert">
    <%= error %>
  </div>
<% } %>

<!-- breadcrumb part start-->
<section class="breadcrumb_part">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb_iner">
          <h2>Cart List</h2>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- breadcrumb part end-->
</section>
<!-- breadcrumb part end-->

<% if (couponMessage) { %>
  <div class="container mt-3">
    <div class="alert <%= couponSuccess === 'true' ? 'alert-success' : 'alert-danger' %> text-center">
      <%= couponMessage %>
    </div>
  </div>
<% } %>


<!--================Cart Area =================-->
<section class="cart_area section_padding">
  <div class="container">
    <div class="cart_inner">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th scope="col">Product</th>
              <th scope="col">Price</th>
              <th scope="col">Quantity</th>
              <th scope="col">Total</th>
              <th scope="col">Actions</th>
              
            
              
            </tr>
          </thead>

          <tbody>
  <% if (cart && cart.products.length > 0) { %>

    <% cart.
    products.forEach(item => { %>
      <tr>
        <td>
          <div class="media">
            <div class="d-flex">

              <img 
                src="<%= item.productId.images && item.productId.images.length > 0 
                        ? item.productId.images[0] 
                        : 'img/default.png' %>" 
                alt="<%= item.productId.title %>" 
                style="width: 80px; height: 80px; object-fit: cover;"
              >

            </div>

            <div class="media-body">
              <p><%= item.productId.title %></p>
            </div>
          </div>
        </td>

        <td>
          <h5>₹<%= item.productId.price.toFixed(2) %></h5>
        </td>

       <td>
  <div class="product_count">

    <a href="/cart/decrease/<%= item.productId._id %>"
       class="input-number-decrement"
       data-id="<%= item.productId._id %>">
      <i class="ti-minus"></i>
    </a>

    <input class="input-number"
           id="qty-<%= item.productId._id %>"
           type="text"
           value="<%= item.quantity %>"
           readonly>

    <a href="/cart/increase/<%= item.productId._id %>"
       class="input-number-increment"
       data-id="<%= item.productId._id %>">
      <i class="ti-plus"></i>
    </a>

  </div>
</td>

<td>
  <h5 id="total-<%= item.productId._id %>">
  ₹<%= (item.productId.price * item.quantity).toFixed(2) %>
</h5>

</td>


        <td>
         

          <a href="/cart/remove/<%= item.productId._id %>"
              class="btn btn-danger btn-sm delete-btn"
                title="Delete">
                <i class="fa fa-trash"></i>
          </a>

        </td>

      </tr>
    <% }) %>

 
  


  <% } else { %>

    <tr>
      <td colspan="5" class="text-center py-5">Your cart is empty.</td>
    </tr>

  <% } %>
</tbody>

        </table>

        <div class="row justify-content-end mt-4">
  <div class="col-md-5">

    <!-- Cart Summary -->
    <div class="cart-summary">
      <table class="table">
        <thead>
          <tr>
            <th>Total</th>
            <th class="text-right">Price</th>
          </tr>
        </thead>
       <tbody>
  <tr>
    <td>Subtotal:</td>
    <td class="text-right">
      ₹<%= subtotal.toFixed(2) %>
    </td>
  </tr>

  <% if (cart.couponApplied) { %>
    <tr>
      <td>Discount:</td>
      <td class="text-right text-success">
        -₹<%= discountAmount.toFixed(2) %>
      </td>
    </tr>
  <% } %>

  <tr class="font-weight-bold">
    <td>Total:</td>
    <td class="text-right">
      ₹<%= total.toFixed(2) %>
    </td>
  </tr>
</tbody>


      </table>

      

      <!-- Apply Coupon -->
      <h5>Apply Coupon</h5>
      <form action="/apply-coupon" method="POST" class="coupon-form">
       <input
           type="text"
           name="couponCode"
           class="form-control mb-3"
           placeholder="Coupon"
           required
        >

        <button type="submit" class="btn btn-warning">
          APPLY
        </button>
      </form>

    </div>
  </div>
</div>


        <% if (cart.products.length > 0) { %>
          <div class="checkout_btn_inner float-right">
            <a class="btn_1" href="/product_list">Continue Shopping</a>
            <a class="btn_1 checkout_btn_1" href="/checkout">Proceed to checkout</a>
           

          </div>
        <% } %>

      </div>
    </div>
  </div>
</section>


<!--================End Cart Area =================-->

<%- include('../partials/footer') %>
<div id="confirmPopup" class="confirm-popup">
  <div class="popup-box">
    <p>Are you sure you want to delete this product?</p>

    <div class="popup-buttons">
      <button id="confirmYes">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const deleteButtons = document.querySelectorAll(".delete-btn");
  const popup = document.getElementById("confirmPopup");
  const yesBtn = document.getElementById("confirmYes");
  const noBtn = document.getElementById("confirmNo");

  let targetHref = null;

  deleteButtons.forEach(btn => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();  
      targetHref = this.getAttribute("href"); 
      popup.classList.add("show");
    });
  });

  yesBtn.addEventListener("click", function () {
    popup.classList.remove("show");
    if (targetHref) {
      window.location.href = targetHref;
    }
  });

  noBtn.addEventListener("click", function () {
    popup.classList.remove("show");
    targetHref = null;
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const updateCartDisplay = (productId, data) => {
    if (data.removed) {
      const row = document.getElementById(`row-${productId}`);
      if (row) row.remove();
    } else {
      document.getElementById(`qty-${productId}`).value = data.quantity;
      document.getElementById(`total-${productId}`).innerText = `₹${data.itemTotal.toFixed(2)}`;
    }
    document.getElementById("cart-subtotal").innerText = `₹${data.subtotal.toFixed(2)}`;
  };

  document.querySelectorAll(".input-number-increment").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = btn.dataset.id;

      try {
        const res = await fetch(`/cart/increase/${productId}`);
        const data = await res.json();
        if (data.success) updateCartDisplay(productId, data);
      } catch (err) {
        console.error(err);
      }
    });
  });

  document.querySelectorAll(".input-number-decrement").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = btn.dataset.id;

      try {
        const res = await fetch(`/cart/decrease/${productId}`);
        const data = await res.json();
        if (data.success || data.removed) updateCartDisplay(productId, data);
      } catch (err) {
        console.error(err);
      }
    });
  });

});
</script>



</body>
</html>