<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
    <link rel="icon" href="/img/LL.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Animation and carousel -->
    <link rel="stylesheet" href="/css/animate.css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css">

    <!-- Font Awesome & Icons -->
    <link rel="stylesheet" href="/css/all.css">
    <link rel="stylesheet" href="/css/flaticon.css">
    <link rel="stylesheet" href="/css/themify-icons.css">

    <!-- Popup & Slider -->
    <link rel="stylesheet" href="/css/magnific-popup.css">
    <link rel="stylesheet" href="/css/slick.css">

    <!-- Shared and page-specific CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/cart.css">
</head>
<body>
   <%- include('../partials/header') %>


<!-- BREADCRUMB -->

  <section class="breadcrumb_part">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="breadcrumb_iner">
            <h2>Cart List</h2>
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- ALERTS -->
<% if (success && success.length > 0) { %>
  <div class="alert alert-success">
    <%= success[0] %>
  </div>
<% } %>

<% if (error && error.length > 0) { %>
  <div class="alert alert-danger">
    <%= error[0] %>
  </div>
<% } %>

<!-- CART AREA -->
<section class="cart_area section_padding"> 
  <div class="container"> 
    <div class="cart_inner">
       <div class="table-responsive">
         <table class="table">
           <thead> 
            <tr> 
              <th scope="col">Product</th> 
              <th scope="col">Price</th> 
              <th scope="col">Quantity</th> 
              <th scope="col">Total</th> 
              <th scope="col">Actions</th> 
              </tr> 
               </thead>

            <tbody>
              <% if (cart && cart.products.length > 0) { %>
                <% cart.products.forEach(item => { %>
                  <tr id="row-<%= item.productId._id %>">

                   
                    <td class="d-flex align-items-center">
                      <img
                        src="<%= item.productId.images?.[0] || '/img/default.png' %>"
                        class="cart-img"
                      >
                      <span class="ml-3"><%= item.productId.title %></span>
                    </td>

                    <td>₹<%= item.productId.price.toFixed(2) %></td>

                    <td>
                      <div class="product_count">
                        <a href="/cart/decrease/<%= item.productId._id %>"
                           class="input-number-decrement"
                           data-id="<%= item.productId._id %>">
                          <i class="ti-minus"></i>
                        </a>

                        <input class="input-number"
                               id="qty-<%= item.productId._id %>"
                               value="<%= item.quantity %>"
                               readonly>

                        <a href="/cart/increase/<%= item.productId._id %>"
                           class="input-number-increment"
                           data-id="<%= item.productId._id %>">
                          <i class="ti-plus"></i>
                        </a>
                      </div>
                    </td>

                    <td id="total-<%= item.productId._id %>">
                      ₹<%= (item.productId.price * item.quantity).toFixed(2) %>
                    </td>

                    <td>
                      <a href="/cart/remove/<%= item.productId._id %>"
                         class="btn btn-danger btn-sm delete-btn">
                        <i class="fa fa-trash"></i>
                      </a>
                    </td>

                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="text-center py-5">
                    Your cart is empty.
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="col-lg-4">
        <div class="cart-summary">

          <table class="table">
            <tr>
              <th>Subtotal</th>
              <td class="text-right" id="cart-subtotal">
                ₹<%= subtotal.toFixed(2) %>
              </td>
            </tr>

            <% if (cart.couponApplied) { %>
              <tr>
                <th>Discount</th>
                <td class="text-right text-success">
                  -₹<%= discountAmount.toFixed(2) %>
                </td>
              </tr>
            <% } %>

            <tr class="font-weight-bold">
              <th>Total</th>
              <td class="text-right">
                ₹<%= total.toFixed(2) %>
              </td>
            </tr>
          </table>


          <!-- COUPON -->
         <% if (cart.couponApplied) { %>
  <div class="alert alert-info text-center">
    Coupon "<strong><%= cart.couponCode %></strong>" is already applied
  </div>

  <form method="POST" action="/cart/coupon-remove">
    <button class="btn btn-outline-danger btn-block">
      Remove Coupon
    </button>
  </form>
  <% } else { %>
  <h5>Apply Coupon</h5>
  <form action="/apply-coupon" method="POST">
    <input
      class="form-control mb-2 coupon-input"
      name="couponCode"
      placeholder="Coupon"
      required
    >
    <button class="btn apply-coupon-btn btn-block">
      APPLY
    </button>
  </form>
  <% } %>

        </div>
      </div>
        <% if (cart.products.length > 0) { %>
      <div class="cart-action-buttons mt-4">
         <a href="/product_list" class="btn_1">Continue Shopping</a>
         <a href="/checkout" class="btn_1 checkout_btn_1">Proceed to Checkout</a>
      </div>
  <% } %>
    </div>

</section>

<%- include('../partials/footer') %>
<div id="confirmPopup" class="confirm-popup">
  <div class="popup-box">
    <p>Are you sure you want to delete this product?</p>

    <div class="popup-buttons">
      <button id="confirmYes">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const deleteButtons = document.querySelectorAll(".delete-btn");
  const popup = document.getElementById("confirmPopup");
  const yesBtn = document.getElementById("confirmYes");
  const noBtn = document.getElementById("confirmNo");

  let targetHref = null;

  deleteButtons.forEach(btn => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();  
      targetHref = this.getAttribute("href"); 
      popup.classList.add("show");
    });
  });

  yesBtn.addEventListener("click", function () {
    popup.classList.remove("show");
    if (targetHref) {
      window.location.href = targetHref;
    }
  });

  noBtn.addEventListener("click", function () {
    popup.classList.remove("show");
    targetHref = null;
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const updateCartDisplay = (productId, data) => {
  // Remove product row if removed
  if (data.removed) {
    const row = document.getElementById(`row-${productId}`);
    if (row) row.remove();
  } else {
    // Update quantity
    const qtyInput = document.getElementById(`qty-${productId}`);
    if (qtyInput) qtyInput.value = data.quantity;

    // Update item total
    const itemTotalCell = document.getElementById(`total-${productId}`);
    if (itemTotalCell) itemTotalCell.innerText = `₹${data.itemTotal.toFixed(2)}`;
  }

  // Update subtotal
  const subtotalCell = document.getElementById("cart-subtotal");
  if (subtotalCell) subtotalCell.innerText = `₹${data.subtotal.toFixed(2)}`;

  // Update discount (if any)
  const discountCell = document.querySelector(".cart-summary .text-success");
  if (discountCell && data.discountAmount !== undefined) {
    discountCell.innerText = `-₹${data.discountAmount.toFixed(2)}`;
  }

  // Update total
  const totalCell = document.querySelector(".cart-summary .font-weight-bold td");
  if (totalCell) totalCell.innerText = `₹${data.total.toFixed(2)}`;
};


  document.querySelectorAll(".input-number-increment").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = btn.dataset.id;

      try {
        const res = await fetch(`/cart/increase/${productId}`);
        const data = await res.json();
        if (data.success) updateCartDisplay(productId, data);
      } catch (err) {
        console.error(err);
      }
    });
  });

  document.querySelectorAll(".input-number-decrement").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const productId = btn.dataset.id;

      try {
        const res = await fetch(`/cart/decrease/${productId}`);
        const data = await res.json();
        if (data.success || data.removed) updateCartDisplay(productId, data);
      } catch (err) {
        console.error(err);
      }
    });
  });

});
</script>



</body>
</html>