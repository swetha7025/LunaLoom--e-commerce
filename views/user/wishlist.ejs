<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Wishlist</title>

    <link rel="icon" href="/img/LL.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Animation and carousel -->
    <link rel="stylesheet" href="/css/animate.css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css">

    <!-- Font Awesome & Icons -->
    <link rel="stylesheet" href="/css/all.css">
    <link rel="stylesheet" href="/css/flaticon.css">
    <link rel="stylesheet" href="/css/themify-icons.css">

    <!-- Popup & Slider -->
    <link rel="stylesheet" href="/css/magnific-popup.css">
    <link rel="stylesheet" href="/css/slick.css">

    <!-- Shared and page-specific CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/wishlist.css">
</head>

<body>

<%- include('../partials/header') %>

<section class="wishlist-hero-section">
    <div class="container">
        <h2>Your Wishlist</h2>
    </div>
</section>

<div class="container mt-4">

    <!-- SUCCESS MESSAGE -->
    <% if (success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= success %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <!-- ERROR MESSAGE -->
    <% if (error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>


    <% if (!wishlist || !wishlist.products || wishlist.products.length === 0) { %>

        <div class="empty-box">
            Your wishlist is empty.
        </div>

    <% } else { %>

        <div class="wishlist-container">

            <% wishlist.products.forEach(item => { %>
                <% const product = item.productId; %>

                <div class="wishlist-card">

                    <!-- Product Image -->
                   <a href="/product/<%= product._id %>">
  <img
    src="<%= product.images && product.images.length > 0 ? product.images[0] : '/img/no-image.png' %>"
    alt="Product Image"
  >
</a>


                    <h5 class="mt-3"><%= product.name %></h5>
                    <p class="text-muted"><%= product.category %></p>
                    <p class="fw-bold">â‚¹ <%= product.price %></p>
                 <!-- 
                    <a href="/product/<%= product._id %>" class="btn btn-primary btn-sm mt-2">
                        View Product
                    </a>
                 -->


                 <a href="/cart/add/<%= product._id %>"
                  class="btn btn-primary btn-sm mt-2 add-cart-btn"
                  onclick="addToCart('<%= product._id %>', this, event)">
                  <span class="cart-text">Add to Cart</span>
                 </a>

                    <!-- Remove Button -->
                   <form action="/wishlist/remove/<%= product._id %>" method="POST" class="remove-form">
                   <button class="btn-remove">Remove</button>
                   </form>

                </div>
            <% }) %>

        </div>

    <% } %>

</div>

<%- include('../partials/footer') %>

<script src="/js/bootstrap.bundle.min.js"></script>
<div id="confirmPopup" class="confirm-popup">
  <div class="popup-box">
    <p>Are you sure you want to remove this product?</p>

    <div class="popup-buttons">
      <button id="confirmYes">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const forms = document.querySelectorAll(".remove-form");
  const popup = document.getElementById("confirmPopup");
  const yesBtn = document.getElementById("confirmYes");
  const noBtn = document.getElementById("confirmNo");

  let currentForm = null;

  forms.forEach(form => {
    form.addEventListener("submit", function (e) {
      e.preventDefault();  
      currentForm = form; 
      popup.classList.add("show");
    });
  });

  yesBtn.addEventListener("click", function () {
    popup.classList.remove("show");
    if (currentForm) currentForm.submit();
  });

  noBtn.addEventListener("click", function () {
    popup.classList.remove("show");
    currentForm = null;
  });
});
</script>
<script>
  function addToCart(productId, el, event) {
    event.preventDefault();

    fetch(`/cart/add/${productId}`, {
      method: "POST",
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {

      const text = el.querySelector(".cart-text");

      if (data.alreadyInCart) {
        text.innerText = "Already in Cart";
      } else if (data.success) {
        text.innerText = "Added to Cart";
      }

      el.style.pointerEvents = "none";
      el.style.opacity = "0.85";
    })
    .catch(err => console.log(err));
  }
</script>

</body>
</html>
