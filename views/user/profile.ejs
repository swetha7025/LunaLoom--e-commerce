<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile</title>

  
 
  <link rel="stylesheet" href="/css/profile.css">
 
  <link rel="stylesheet" href="/css/all.css">
  <link rel="icon" href="/img/LL.png">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">

  <!-- Animation and carousel -->
  <link rel="stylesheet" href="/css/animate.css">
  <link rel="stylesheet" href="/css/owl.carousel.min.css">

  <!-- Font Awesome & Icons -->
  <link rel="stylesheet" href="/css/all.css">
  <link rel="stylesheet" href="/css/flaticon.css">
  <link rel="stylesheet" href="/css/themify-icons.css">

  <!-- Popup & Slider -->
  <link rel="stylesheet" href="/css/magnific-popup.css">
  <link rel="stylesheet" href="/css/slick.css">

  <!-- Shared and page-specific CSS -->
  <link rel="stylesheet" href="/css/style.css"> <!-- main site styles (home, header, etc.) -->
  <link rel="stylesheet" href="/css/header.css"> <!-- header/navbar styles -->
  <link rel="stylesheet" href="/css/footer.css">
</head>

<body>

<%- include('../partials/header') %>

<div class="container-fluid profile-container">
  <div class="row justify-content-center">

    <!-- ================= SIDEBAR ================= -->
    <div class="col-md-3 sidebar">
      <div class="profile-card text-center">

        <!-- Profile Image -->
        <div class="profile-photo-container">
          <% if (user.profileImage) { %>
            <img src="<%= user.profileImage %>" class="profile-photo" alt="profile">
          <% } else { %>
            <div class="profile-initial">
              <%= user.name ? user.name.charAt(0).toUpperCase() : "U" %>
            </div>
          <% } %>

          <label for="profileUpload" class="edit-icon">
            <i class="fas fa-camera"></i>
          </label>

          <form action="/uploadProfileImage" method="POST" enctype="multipart/form-data">
            <input
              type="file"
              id="profileUpload"
              name="profileImage"
              hidden
              onchange="this.form.submit()">
          </form>
        </div>

        <h4 class="profile-name"><%= user.name %></h4>
        <p class="profile-email"><%= user.email %></p>
        <p class="profile-phone"><%= user.phone %></p>

        <a href="/editProfile" class="btn custom-edit-btn w-100 mb-3">
          EDIT PROFILE
        </a>

        <!-- Navigation -->
        <ul class="nav flex-column">
          <li class="nav-item">
            <a href="/profile"
               class="nav-link <%= tab === 'orders' ? 'active' : '' %>">
              My Orders
            </a>
          </li>

          <li class="nav-item">
            <a href="/address" class="nav-link">Address</a>

               <!-- class="nav-link <%= tab === 'address' ? 'active' : '' %>">
              Address -->
            </a>
          </li>

          <li class="nav-item">
            <a href="#" class="nav-link">Payment Methods</a>
          </li>
        </ul>

        <a href="/logout" class="logout mt-3 d-block">Logout</a>
      </div>
    </div>

    <!-- ================= RIGHT CONTENT ================= -->
    <div class="col-md-7 orders-section">

      <% if (success) { %>
        <div class="alert alert-success alert-dismissible fade show">
          <%= success %>
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
      <% } %>

      <% if (error) { %>
        <div class="alert alert-danger alert-dismissible fade show">
          <%= error %>
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
      <% } %>

      <!-- ===== ORDERS TAB ===== -->
      <% if (tab === 'orders') { %>
  <h3 class="orders-title">My Orders</h3>

 <% if (orders && orders.length > 0) { %>

  <% orders.forEach(order => { %>
    <div class="card mb-3 p-3 order-card">

      <div class="d-flex justify-content-between mb-2">
        <div>
          <p><strong>Order ID:</strong> <%= order._id %></p>
          <p><strong>Date:</strong> <%= new Date(order.createdAt).toDateString() %></p>
        </div>

        <div>
          <p><strong>Total:</strong> â‚¹<%= order.totalAmount %></p>
        </div>
      </div>

      <% order.items.forEach(item => { %>
        <% if (item.product) { %>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong><%= item.product.name %></strong><br>
              <small>Qty: <%= item.quantity %></small>
            </div>

           <% if (order.orderStatus === 'Delivered') { %>
    <button
    class="btn btn-sm btn-warning"
    data-toggle="modal"
    data-target="#ratingModal"
    onclick="openRatingModal(
      '<%= item.product._id %>',
      '<%= item.product.name %>'
    )">
    Rate
    </button>
<% } else { %>
  <button class="btn btn-sm btn-secondary" disabled>
    Rate after delivery
  </button>
<% } %>

          </div>
        <% } %>
      <% }) %>

    </div>
  <% }) %>

<% } else { %>
  <p class="text-center">No Orders Found</p>
<% } %>

<% } %>


      <!-- ===== ADDRESS TAB ===== -->
      <% if (tab === 'address') { %>
        <h3 class="orders-title">My Address</h3>

        <% if (address) { %>
          <!-- Saved Address -->
          <div class="card p-4">
            <p><strong>Label:</strong> <%= address.label %></p>
            <p><strong>Street:</strong> <%= address.street %></p>
            <p><strong>City:</strong> <%= address.city %></p>
            <p><strong>District:</strong> <%= address.district %></p>
            <p><strong>Country:</strong> <%= address.country %></p>
            <p><strong>Pincode:</strong> <%= address.pincode %></p>
            <p><strong>Phone:</strong> <%= address.phone %></p>

            <!-- <a href="/profile?tab=edit-address" class="btn btn-outline-primary">
              Edit Address
            </a> -->
          <div class="mt-3 text-left">
         <a href="/editAddress" class="edit-btn">
          Edit
         </a>
          </div>
          </div>

        <% } else { %>
          <!-- Address Form -->
          <form action="/address/save" method="POST" class="card p-4">
            <input name="label" class="form-control mb-2" placeholder="Home / Office" required>
            <input name="street" class="form-control mb-2" placeholder="Street" required>
            <input name="city" class="form-control mb-2" placeholder="City" required>
            <input name="district" class="form-control mb-2" placeholder="District" required>
            <input name="country" class="form-control mb-2" placeholder="Country" required>
            <input name="pincode" class="form-control mb-2" placeholder="Pincode" required>
            <input name="phone" class="form-control mb-3" placeholder="Phone" required>

            <button type="submit" class="btn btn-warning w-100">
              Save Address
            </button>
          </form>
        <% } %>
      <% } %>

    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<div class="modal fade" id="ratingModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-2 border-warning">

      <form action="/product/rating" method="POST">

        <div class="modal-header">
          <h5 class="modal-title text-warning fw-bold">Rate Product</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>

        <div class="modal-body">

          <h6 id="ratingProductName" class="mb-3"></h6>

          <input type="hidden" name="productId" id="ratingProductId">

          <label class="fw-bold">Your Rating:</label>
          <select name="rating" class="form-control mb-3" required>
            <option value="">Select Rating</option>
            <option value="1">1 - Very Bad</option>
            <option value="2">2 - Bad</option>
            <option value="3">3 - Okay</option>
            <option value="4">4 - Good</option>
            <option value="5">5 - Excellent</option>
          </select>

          <label class="fw-bold">Review:</label>
          <textarea
            name="comment"
            class="form-control"
            rows="3"
            placeholder="Write your review..."></textarea>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
          <button type="submit" class="btn btn-warning">
            Submit
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

<script>
  function openRatingModal(productId, productName) {
    document.getElementById('ratingProductId').value = productId
    document.getElementById('ratingProductName').innerText = productName
  }
</script>

</body>
</html>
